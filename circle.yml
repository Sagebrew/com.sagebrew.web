machine:
  services:
    - neo4j
    - rabbitmq-server
    - docker


dependencies:
  cache_directories:
    - neo4j
    - elasticsearch-1.3.2
  post:
    - pip install -r ../requirements/base.txt
    - sudo chown ubuntu /etc/rsyslog.d/
    - ~/virtualenvs/venv-system/bin/python ~/com.sagebrew.web/sagebrew/manage.py logglypopulation $LOG_ACCOUNT $LOG_TOKEN
    - sudo chown root /etc/rsyslog.d/
    - sudo service rsyslog restart
    - if [[ ! -e elasticsearch-1.3.2 ]]; then wget https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-1.3.2.tar.gz && tar -xvf elasticsearch-1.3.2.tar.gz; fi
    - elasticsearch-1.3.2/bin/elasticsearch: {background: true}
    - cd ~/com.sagebrew.web/sagebrew && ~/virtualenvs/venv-system/bin/celery -A sagebrew worker -l info -n worker1:
        background: true
    - cd ~/com.sagebrew.web/sagebrew && ~/virtualenvs/venv-system/bin/celery -A sagebrew worker -l info -n worker2:
        background: true
    - cd ~/com.sagebrew.web/sagebrew && ~/virtualenvs/venv-system/bin/celery -A sagebrew beat -l info:
        background: true
    - python ~/com.sagebrew.web/sagebrew/manage.py runserver 127.0.0.1:8080:
        background: true
    - ~/virtualenvs/venv-system/bin/python ~/com.sagebrew.web/sagebrew/manage.py clear_neo_db


test:
  post:
    - ~/virtualenvs/venv-system/bin/python ~/com.sagebrew.web/sagebrew/manage.py clear_neo_db
    - ~/virtualenvs/venv-system/bin/python ~/com.sagebrew.web/sagebrew/manage.py dockerfilepopulation
    - sed "s/<EMAIL>/$DOCKER_EMAIL/;s/<AUTH>/$DOCKER_AUTH/" < ~/com.sagebrew.web/dockercfg.template > ~/.dockercfg
    - docker build --no-cache=$CLEAR_CACHE -t sb_worker ~/com.sagebrew.web/dockerfiles/worker/
    - docker build --no-cache=$CLEAR_CACHE -t sb_web ~/com.sagebrew.web/dockerfiles/web_app/
    - docker run -h box-worker -e NEO4J_REST_URL=$NEO4J_REST_URL -e APP_USER=$APP_USER -e REPO_NAME=$REPO_NAME -e PROJECT_NAME=$PROJECT_NAME -e LOG_ACCOUNT=$LOG_ACCOUNT -e LOG_TOKEN=$LOG_TOKEN sb_worker
    - docker run -h box-webapp -e NEO4J_REST_URL=$NEO4J_REST_URL -e APP_USER=$APP_USER -e REPO_NAME=$REPO_NAME -e PROJECT_NAME=$PROJECT_NAME -e LOG_ACCOUNT=$LOG_ACCOUNT -e LOG_TOKEN=$LOG_TOKEN sb_web

checkout:
  post:
    - git submodule sync
    - git submodule update --init

general:
  build_dir: sagebrew

