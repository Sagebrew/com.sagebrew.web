machine:
  services:
    - rabbitmq-server
    - elasticsearch
    - docker


dependencies:
  post:
    - pip install -r ../requirements/base.txt
    - pip install git+https://github.com/robinedwards/neomodel.git@0.3.6
    - sudo chown ubuntu /etc/rsyslog.d/
    - ~/virtualenvs/venv-system/bin/python ~/com.sagebrew.web/sagebrew/manage.py logglypopulation
    - sudo chown root /etc/rsyslog.d/
    - sudo service rsyslog restart
    - cd ~/com.sagebrew.web/sagebrew && ~/virtualenvs/venv-system/bin/celery -A sagebrew worker -l info -n worker1:
        background: true
    - cd ~/com.sagebrew.web/sagebrew && ~/virtualenvs/venv-system/bin/celery -A sagebrew worker -l info -n worker2:
        background: true
    - python ~/com.sagebrew.web/sagebrew/manage.py runserver 127.0.0.1:8080:
        background: true
    - ~/virtualenvs/venv-system/bin/python ~/com.sagebrew.web/sagebrew/manage.py clear_neo_db

test:
  post:
    - ~/virtualenvs/venv-system/bin/python ~/com.sagebrew.web/sagebrew/manage.py clear_neo_db
    - ~/virtualenvs/venv-system/bin/python ~/com.sagebrew.web/sagebrew/manage.py dockerfilepopulation
    - sed "s/<EMAIL>/$DOCKER_EMAIL/;s/<AUTH>/$DOCKER_AUTH/" < ~/com.sagebrew.web/dockercfg.template > ~/.dockercfg
    - docker build -t sb_worker ~/com.sagebrew.web/dockerfiles/worker/
    - docker build -t sb_web ~/com.sagebrew.web/dockerfiles/web_app/
    - docker run -h box-worker -env-file /home/apps/env_lists/worker_env sb_worker
    - docker run -h box-webapp -env-file /home/apps/env_lists/web_env sb_web

#test:
#  override:
#    - Run tests using default setup
#    - Compile docker build
#    - Test docker build
#    - Push docker build to staging beanstalk if master
#         push to elastic beanstalk master
#    - If staging Run tests against staging beanstalk from CI
#    - If Staging merge with master (Let process reiterate)
#  post:
#    - docker run -d -p 3000:3000 -e "SECRET_KEY_BASE=abcd1234" \
#          circleci/hello:$CIRCLE_SHA1; sleep 10
#    - curl --retry 10 --retry-delay 5 -v http://localhost:3000
#    - docker run myimage bundle exec rake test


checkout:
  post:
    - git submodule sync
    - git submodule update --init

general:
  build_dir: sagebrew

