FROM sagebrew/django.web.primary.base:v7

MAINTAINER Devon Bleibtrey <devon@sagebrew.com>

RUN apt-get update && apt-get install -y git
RUN mkdir /home/apps/
RUN mkdir /home/apps/logs


RUN git clone -b {{DOCKER_ENV}} git@github.com:Sagebrew/com.sagebrew.web.git /home/apps/sagebrew/
RUN chown -R {{APP_USER}}:{{APP_USER}} /home/apps/

RUN rm -r /root/.ssh
RUN apt-get remove --auto-remove -y openssh-client

RUN pip install -r /home/apps/sagebrew/requirements/{{REQUIREMENTS_FILE}}.txt
RUN pip install git+https://github.com/robinedwards/neomodel.git@0.3.6
RUN apt-get remove --auto-remove -y git

ENV BOMBERMAN_API_KEY {{BOMBERMAN_API_KEY}}
RUN chown {{APP_USER}} /etc/rsyslog.d/
RUN python /home/apps/sagebrew/sagebrew/manage.py logglypopulation
RUN chown root /etc/rsyslog.d/
RUN service rsyslog restart


RUN chown {{APP_USER}} /etc/supervisor/conf.d/
RUN python /home/apps/sagebrew/sagebrew/manage.py populatesupervisor {{SUPER_TEMPLATE}}
RUN chown root /etc/supervisor/conf.d/

CMD supervisord -c /etc/supervisor/supervisord.conf
